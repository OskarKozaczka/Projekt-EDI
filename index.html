<!DOCTYPE html>
<html>
    <head>
        <title>Aplikacja gie≈Çdowa</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
    </head>
    <body>
        <div id="alphabet">
            <button onclick="b('A')">A</button>
            <button onclick="b('B')">B</button>
            <button onclick="b('C')">C</button>
            <button onclick="b('D')">D</button>
            <button onclick="b('E')">E</button>
            <button onclick="b('F')">F</button>
            <button onclick="b('G')">G</button>
            <button onclick="b('H')">H</button>
            <button onclick="b('I')">I</button>
            <button onclick="b('J')">J</button>
            <button onclick="b('K')">K</button>
            <button onclick="b('L')">L</button>
            <button onclick="b('M')">M</button>
            <button onclick="b('N')">N</button>
            <button onclick="b('O')">O</button>
            <button onclick="b('P')">P</button>
            <button onclick="b('Q')">Q</button>
            <button onclick="b('R')">R</button>
            <button onclick="b('S')">S</button>
            <button onclick="b('T')">T</button>
            <button onclick="b('U')">U</button>
            <button onclick="b('V')">V</button>
            <button onclick="b('W')">W</button>
            <button onclick="b('X')">X</button>
            <button onclick="b('Y')">Y</button>
            <button onclick="b('Z')">Z</button>
        
            <input type="text" name="firstname">
            <button onclick="search()">szukaj</button>
        </div>


        <div class="container">
            <canvas id="myChart"></canvas>
        </div>
    
        <table class="table table-striped">
        <thead class="thead-dark">
            <tr>
                <th scope="col" style="text-align: left;">Nazwa</th>
                <th scope="col">Ticker</th>
                <th scope="col">Wolumen</th>
                <th scope="col">Zmiana</th>
                <th scope="col">Cena</th>

            </tr>
        </thead>
        <tbody>
        </tbody>
        </table>








    <script>
        function b(letterval){
            if(document.querySelectorAll("#row").length>0){
                for(i=0;i<20;i++)
                    document.querySelector("#row").remove();
    
            }

            i=0
            console.log(letterval)
            var letter="^"+letterval
            regexp = new RegExp(letter,"i")

            display2()

        }





        function search(){
            while(document.querySelectorAll("#row").length>0){
                document.querySelector("#row").remove();
            }

            i=0
            var letter=document.querySelector("input").value
            regexp = new RegExp(letter, "i")
            display2()

        }

        Chartjs()
        display2()

        var regexp;
        var i =0;



var xchart = new XMLHttpRequest();
xchart.onreadystatechange = function () {
  if (this.readyState == 4 && this.status == 200) {
    var chartdata = JSON.parse(this.response);
    chartdata = Array.prototype.slice.call(chartdata)
    var slabels = chartdata.map(function (e) {  // Czemu to nie bierze danych?????
      return e.data.name;
    });
    Chartjs(slabels);
  }
};
xchart.open("GET", "https://api.twelvedata.com/stocks");
xchart.send();

function display2()
{


var request=new XMLHttpRequest();
request.onreadystatechange = function()
{
    if (this.readyState == 4 && this.status == 200)
    {  
        Response=JSON.parse(this.responseText)
        
        display()

    }

    
}
request.open("GET","https://api.twelvedata.com/stocks" );
request.send();

}


    
function Chartjs(slabels)
{
    var myChart = document.getElementById('myChart').getContext('2d');
        var stockChart = new Chart(myChart, {
            type: 'line',
            data: {
                labels: slabels,
                datasets: [{
                    label: 'Value',
                    data: [10,20],
                }],
            options: {}
            
            }

        });
}

function display()
{
    var Cena=0;


    



    Response.data.forEach(element => {

        if (i<20)
        {

        if(element.symbol.match(regexp)||element.name.match(regexp))
        {

var request=new XMLHttpRequest();
request.onreadystatechange = function()
{
    if (this.readyState == 4 && this.status == 200)
    {  
        Response2=JSON.parse(this.responseText)


        Cena=Response2.values["0"]["close"]
        difference=((Response2.values["0"]["close"]-Response2.values["1"]["close"])/Response2.values["0"]["close"])*100
        difference=Math.round(difference*100)/100;
        volume=Response2.values["0"]["volume"]
        let output = `
            <td>${element["name"]}</td>
            <td>${element["symbol"]}</td>
            <td>${volume}</td>
            <td id=diff>${difference}%</td>
            <td>${Cena}</td>

        `
        let row = document.createElement("tr") 
        row.setAttribute("id", i)
        row.setAttribute("clicked", false)
        //row.setAttribute("onClick", "click(this)")
        row.addEventListener('click', click, true)
        row.setAttribute("id","row") 
        
        
        row.innerHTML = output
        document.querySelector("tbody").appendChild(row)
        

        if (difference<0 )row.querySelector("#diff").setAttribute("style","color:red")
        if (difference>0 )row.querySelector("#diff").setAttribute("style","color:green")

    }

    i++
}

request.open("GET","https://api.twelvedata.com/time_series?symbol="+element.symbol+"&interval=1day&apikey=a3e9aa227fd0474494e62f3148d0d7e0&outputsize=2" );
request.send();



}


}

    });


}




function click(el)
{

el.target.setAttribute("clicked",true)



let output = `

            <td>Test</td>
            <td>Test</td>
            <td>Test/td>
            <td>Test</td>
            <td>Test</td>

        `

let details = document.createElement("tr") 

details.innerHTML = output


document.querySelector('[clicked=true]').appendChild(details)

}



</script>

</body>
</html>