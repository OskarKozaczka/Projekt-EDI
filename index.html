<!DOCTYPE html>
<html>
    <head>
        <title>Aplikacja giełdowa</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
    </head>
    <body>
        <button onclick="b()">B</button>
        <input type="text" name="firstname">
        <button onclick="search()">szukaj</button>
        
        <div class="container">
            <canvas id="myChart"></canvas>
        </div>
    
        <table class="table table-striped">
        <thead class="thead-dark">
            <tr>
                <th scope="col" style="text-align: left;">Nazwa</th>
                <th scope="col">Wolumen</th>
                <th scope="col">Różnica względem wczoraj</th>
                <th scope="col">Cena</th>

            </tr>
        </thead>
        <tbody>
        </tbody>
        </table>








    <script>
        function b(){
            while(document.querySelectorAll("#row").length>0){
                document.querySelector("#row").remove();
    
            }

            i=0
            var letter="^"+"b"
            regexp = new RegExp(letter,"i")

            display2()

        }





        function search(){
            while(document.querySelectorAll("#row").length>0){
                document.querySelector("#row").remove();
            }

            i=0
            var letter=document.querySelector("input").value
            regexp = new RegExp(letter, "i")
            display2()

        }

        Chartjs()
        display2()

        var regexp;
        var i =0;



var xchart = new XMLHttpRequest();
xchart.onreadystatechange = function () {
  if (this.readyState == 4 && this.status == 200) {
    var chartdata = JSON.parse(this.response);
    chartdata = Array.prototype.slice.call(chartdata)
    var slabels = chartdata.map(function (e) {  // Czemu to nie bierze danych?????
      return e.data.name;
    });
    Chartjs(slabels);
  }
};
xchart.open("GET", "https://api.twelvedata.com/stocks");
xchart.send();

function display2()
{


var request=new XMLHttpRequest();
request.onreadystatechange = function()
{
    if (this.readyState == 4 && this.status == 200)
    {  
        Response=JSON.parse(this.responseText)
        
        display()

    }

    
}
request.open("GET","https://api.twelvedata.com/stocks" );
request.send();

}


    
function Chartjs(slabels)
{
    var myChart = document.getElementById('myChart').getContext('2d');
        var stockChart = new Chart(myChart, {
            type: 'line',
            data: {
                labels: slabels,
                datasets: [{
                    label: 'Value',
                    data: [10,20],
                }],
            options: {}
            
            }

        });
}

function display()
{
    var Cena=0;


    



    Response.data.forEach(element => {

        if (i<20)
        {

        if(element.symbol.match(regexp)||element.name.match(regexp))
        {

var request=new XMLHttpRequest();
request.onreadystatechange = function()
{
    if (this.readyState == 4 && this.status == 200)
    {  
        Response2=JSON.parse(this.responseText)


        Cena=Response2.values["0"]["close"]
        difference=Response2.values["0"]["close"]-Response2.values["1"]["close"]
        difference=Math.round(difference*10000)/10000;
        volume=Response2.values["0"]["volume"]

        let output = `
            <td>${element["name"]}</td>
            <td>${volume}</td>
            <td>${difference}</td>
            <td>${Cena}</td>

        `
        let row = document.createElement("tr") 

        row.setAttribute("id","row") 
        row.innerHTML = output
    
        document.querySelector("tbody").appendChild(row)
        

        //console.log(i)

    }

    i++
}

request.open("GET","https://api.twelvedata.com/time_series?symbol="+element.symbol+"&interval=1day&apikey=a3e9aa227fd0474494e62f3148d0d7e0&outputsize=2" );
request.send();



}


}

    });


}








</script>

</body>
</html>